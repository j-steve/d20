extends ./layout

block styles
	style.
		body {
			background:hsl(219, 16%, 36%)
		}
		.header {
			color:white;
			text-shadow:2px 2px 0px #000000;
		}
		img.thumbnail-image {
			height:300px;
		}
		.description {
			height:210px;
		}
		/*
		.description p {
			overflow:hidden;
			text-overflow:ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 10;
			-webkit-box-orient: vertical;
		}
		*/
		
		.thumbnail {
			cursor:pointer;
		}
		.thumbnail:focus {
			background-color:hsl(60, 100%, 91%);
		}
		.thumbnail:focus .description p {
			/*-webkit-line-clamp: 7*/
		}
		.choose-class {
		 	visibility:hidden;
		 	float:right;
		 	margin-right:10px;
		 }
		.thumbnail:focus .choose-class {
			visibility:visible;
		}
		
		.modal-body .list-group-item {
			cursor:pointer;
		}
		.modal-footer .btn {visibility:hidden;}
		.modal-footer.show-button .btn {visibility:invisible;}
		.modal-footer.show-button .btn {visibility:visible;}
		.modal-footer.show-button .message {display:none;}
		
		.list-group-item:hover {
			color: #555;
			text-decoration: none;
			background-color: #f5f5f5;
		}
		.list-group-item input[type=checkbox] {display:none;}
		
		.submit-blur {
			position:fixed;
			top:0px;
			left:0px;
			width: 100%;
			background:black;
			z-index:999;
			transition-property: opacity;
			transition-duration: 500ms;
			height: 0;
			opacity: 0;
		}
		.submit-blur.shown {
			transition-property: opacity;
			transition-duration: 500ms;
			height: 100%;
			opacity: .75;
		}

block content
	.submit-blur
	h2.header Select a #{title}:
	div.row
		for ddclass in ddclasses
			div.col-sm-4.col-md-2
				form.thumbnail(action=nextPage, tabindex="0")
					each vals, key in query
						each val in [].concat(vals || [])
							input(type="hidden", name=key, value=val)
					input(type="hidden", name=title.toLowerCase(), value=ddclass.name)
					img(src=ddclass.image, alt="...").thumbnail-image
					div.caption
					h3=ddclass.name
					.description: p=ddclass.description
					p
						button(type="button", tabindex="-1", onclick="return false;").btn.btn-primary.choose-class="Choose " + ddclass.name
						div(style="clear:both;")
					.decision-dialogs
						each decision in ddclass.decisions
							.modal.fade(data-count=decision.count, role="dialog"): .modal-dialog(role="document"): .modal-content
								.modal-header
									button.close(type="button", data-dismiss="modal", aria-label="Close"): span(aria-hidden="true") &times;
									h3.modal-title Select #{decision.name}
								.modal-body
									ul.list-group
										for option in decision.options
											li.list-group-item
												h4.list-group-item-heading #{option.name}
												p.list-group-item-text #{option.description}
												input(type="checkbox", name=decision.paramName, value=option.name)
								.modal-footer
									button(type="button").btn.btn-primary="Continue"
									span.message 
										if (decision.count === 1)
											|Select a #{decision.name.toLowerCase()} to continue.
										else
											|Add <span class="deficitCount">#{decision.count}</span> #{decision.name.toLowerCase()} to continue.
										
										

append scripts
	script.
		$(function() {
			
			$('.choose-class').on('mousedown click', function() {
				var $dialogs = $(this).parents('.thumbnail').find('.decision-dialogs').children();
				if ($dialogs.length) {
					$dialogs.eq(0).modal('show');
				} else {
					$('.submit-blur').addClass('shown');
					nextPage($(this));
				}
				return false;
			});
			
			$('.modal-body .list-group-item').on('click', function() {
				const $self = $(this);
				if (!$self.hasClass('disabled')) {
					$self.toggleClass('active');
					$self.find(':checkbox').toggleProp('checked');
					const $modal = $self.parents('.modal');
					const $items = $modal.find('.list-group-item');
					const deficitCount = $modal.data('count') - $items.filter('.active').length;
					$items.not('.active').toggleClass('disabled', deficitCount <= 0);
					$modal.find('.modal-footer').toggleClass('show-button', deficitCount <= 0).find('.deficitCount').text(deficitCount);
				}
			});
			
			$('.modal-footer .btn').on('click', function() {
				if (!$(this).hasClass('disabled')) {
					const $modal = $(this).parents('.modal');
					$modal.modal('hide');
					nextPage($modal);
				}
			});
			
			function nextPage($target) {
				$target.parents('form').submit();
			}
		});
	