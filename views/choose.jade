extends ./layout

block styles
	style.
		.modal-body .list-group-item {
			cursor:pointer;
		}
		.modal-footer .btn {visibility:hidden;}
		.modal-footer.show-button .btn {visibility:invisible;}
		.modal-footer.show-button .btn {visibility:visible;}
		.modal-footer.show-button .message {display:none;}
		
		.list-group-item:hover {
			color: #555;
			text-decoration: none;
			background-color: #f5f5f5;
		}
		.list-group-item input[type=checkbox] {display:none;}

block content
	h2 Select a #{title}:
	div.row
		for ddclass in ddclasses
			div.col-sm-4.col-md-2
				form.thumbnail(action=nextPage)
					each val, key in query
						input(type="hidden", name=key, value=val)
					input(type="hidden", name=title.toLowerCase(), value=ddclass.name)
					img(src=ddclass.image, alt="...", style="height:300px;")
					div.caption
					h3=ddclass.name
					p(style="height:200px;")=ddclass.description
					p
						input(type="button", value="Choose " + ddclass.name).btn.btn-primary
					.decision-dialogs
						each decision in ddclass.decisions
							.modal.fade(data-count=decision.count, role="dialog"): .modal-dialog(role="document"): .modal-content
								.modal-header
									button.close(type="button", data-dismiss="modal", aria-label="Close"): span(aria-hidden="true") &times;
									h3.modal-title Select #{decision.name}
								.modal-body
									ul.list-group
										for option in decision.options
											li.list-group-item
												h4.list-group-item-heading #{option.name}
												p.list-group-item-text #{option.description}
												input(type="checkbox", name=decision.paramName, value=option.name)
								.modal-footer
									button(type="button").btn.btn-primary="Continue"
									span.message 
										if (decision.count === 1)
											|Select a #{decision.name.toLowerCase()} to continue.
										else
											|Add <span class="deficitCount">#{decision.count}</span> #{decision.name.toLowerCase()} to continue.
										
										

append scripts
	script.
		$(function() {
			$('input[type=button]').on('click', function() {
				var $dialogs = $(this).parents('.thumbnail').find('.decision-dialogs').children();
				if ($dialogs.length) {
					$dialogs.eq(0).modal('show');
				} else {
					nextPage($(this));
				}
			});
			
			$('.modal-body .list-group-item').on('click', function() {
				const $self = $(this);
				if (!$self.hasClass('disabled')) {
					$self.toggleClass('active');
					$self.find(':checkbox').toggleProp('checked');
					const $modal = $self.parents('.modal');
					const $items = $modal.find('.list-group-item');
					const deficitCount = $modal.data('count') - $items.filter('.active').length;
					$items.not('.active').toggleClass('disabled', deficitCount <= 0);
					$modal.find('.modal-footer').toggleClass('show-button', deficitCount <= 0).find('.deficitCount').text(deficitCount);
				}
			});
			
			$('.modal-footer .btn').on('click', function() {
				if (!$(this).hasClass('disabled')) {
					const $modal = $(this).parents('.modal');
					$modal.modal('hide');
					nextPage($modal);
				}
			});
			
			function nextPage($target) {
				$target.parents('form').submit();
			}
		});
	